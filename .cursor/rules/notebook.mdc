---
description: "Marimo Notebookåˆ©ç”¨æ™‚ã®è¿½åŠ ãƒ«ãƒ¼ãƒ«"
globs: ["notebooks/**/*.py"]
---

# Notebook Usage Rules

1. **Marimoã‚’ä½¿ç”¨**: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–Notebookã¯Marimoã‚’ä½¿ç”¨ã™ã‚‹ã€‚Jupyter Notebookã¯ä½¿ç”¨ã—ãªã„ã€‚
2. **åˆ†æžç›®çš„ã‚’æ˜Žè¨˜**: æœ€åˆã®ã‚»ãƒ«ã«åˆ†æžç›®çš„ã‚’è¨˜è¼‰ã™ã‚‹ã€‚
3. **ä»®æƒ³ç’°å¢ƒã®ä½¿ç”¨**: uvã‚„venvã‚’å¿…ãšä½¿ç”¨ã—ã€Notebookã¯`edit_notebook`ãƒ„ãƒ¼ãƒ«ã§ç·¨é›†ã™ã‚‹ã€‚
4. **ã‚»ãƒ«ã«ã¯è‹±èªžãƒ©ãƒ™ãƒ«**: å¤‰æ•°åã‚„ã‚»ãƒ«IDã¯è‹±èªžã‚’ç”¨ã„ã€èª¬æ˜Žã¯æ—¥æœ¬èªžã§è¡Œã†ã€‚
5. **ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†ã‚’å¾¹åº•**: å‹æ‰‹ãªåˆ†æžã‚’è¡Œã‚ãšã€ãƒ‡ãƒ¼ã‚¿/å›³è¡¨/ãƒ¬ãƒãƒ¼ãƒˆã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ•´ç†ã™ã‚‹ã€‚
6. **ã‚¨ãƒ©ãƒ¼å¯¾å¿œ**: ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯åŽŸå› ã¨å†ç™ºé˜²æ­¢ç­–ã‚’Notebookã«è¿½è¨˜ã™ã‚‹ã€‚
7. **å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹**: S3ãƒ»DuckDBãƒ»JSONã‚¢ã‚¯ã‚»ã‚¹ã¯è³‡æ ¼æƒ…å ±ã‚’.envã‚„ãƒžã‚¦ãƒ³ãƒˆã§ç®¡ç†ã™ã‚‹ã€‚
8. **æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: å¯è¦–åŒ–ã‚„å‡ºåŠ›ã¯ã€Œç›®çš„â†’æ–¹æ³•â†’çµæžœâ†’æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ã®å½¢å¼ã§æ•´ç†ã™ã‚‹ã€‚

## Marimo å¤‰æ•°ç®¡ç†ã®é‡è¦åˆ¶ç´„

### ðŸš« ç¦æ­¢äº‹é …

1. **å¤‰æ•°ã®å†å®šç¾©ã‚’çµ¶å¯¾ã«é¿ã‘ã‚‹**
   - Marimoã§ã¯å…¨ã¦ã®å¤‰æ•°ãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ç®¡ç†ã•ã‚Œã‚‹
   - ç•°ãªã‚‹ã‚»ãƒ«ã§åŒã˜å¤‰æ•°åã‚’ä½¿ã†ã¨ã€ŒThis cell redefines variables from other cellsã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
   - ä¾‹: `fig`, `ax`, `df`ãªã©ã‚’è¤‡æ•°ã‚»ãƒ«ã§å®šç¾©ã—ã¦ã¯ã„ã‘ãªã„

2. **å…·ä½“çš„ãªå›žé¿æ–¹æ³•**
   - Figureå¤‰æ•°: `fig1`, `fig2`, `fig3`...ã¨ç•ªå·ã‚’ä»˜ã‘ã‚‹
   - Axeså¤‰æ•°: `ax1`, `ax2`, `ax3`...ã¨ç•ªå·ã‚’ä»˜ã‘ã‚‹
   - ãƒ«ãƒ¼ãƒ—å¤‰æ•°: `for ax in...`ã§ã¯ãªã`for ax_subplot in...`ãªã©æ˜Žç¤ºçš„ãªåå‰ã‚’ä½¿ã†
   - DataFrameå¤‰æ•°: å‡¦ç†å¾Œã¯`df_processed`, `df_filtered`ãªã©åˆ¥åã‚’ä½¿ã†

3. **Twinè»¸ãªã©ã®ç‰¹æ®Šã‚±ãƒ¼ã‚¹**
   - `ax2 = ax1.twinx()`ã®ã‚ˆã†ãªå ´åˆã€`ax2`ãŒä»–ã®ã‚»ãƒ«ã§ä½¿ã‚ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
   - å¿…è¦ã«å¿œã˜ã¦`ax1_twin`ãªã©ã®æ˜Žç¤ºçš„ãªåå‰ã‚’ä½¿ã†

### âœ… æŽ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```python
# âŒ æ‚ªã„ä¾‹ï¼ˆè¤‡æ•°ã‚»ãƒ«ã§åŒã˜å¤‰æ•°åï¼‰
# Cell 1
fig, ax = plt.subplots()
# Cell 2
fig, ax = plt.subplots()  # ã‚¨ãƒ©ãƒ¼ï¼

# âœ… è‰¯ã„ä¾‹ï¼ˆå„ã‚»ãƒ«ã§ç•°ãªã‚‹å¤‰æ•°åï¼‰
# Cell 1
fig1, ax1 = plt.subplots()
# Cell 2
fig2, ax2 = plt.subplots()
```

## BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç‰¹æ€§ï¼ˆdev_yoake_postsï¼‰

### ðŸ”„ é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„

1. **ãƒ‡ãƒ¼ã‚¿ã®ç‰¹æ€§**
   - åŒã˜ãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆxPostIdï¼‰ãŒæœ€å¤§7æ—¥åˆ†ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼ˆ_PARTITIONTIMEï¼‰ã«å­˜åœ¨ã™ã‚‹
   - ã“ã‚Œã¯æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚ŠéŽåŽ»7æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒä¿æŒã•ã‚Œã‚‹ãŸã‚

2. **å¿…é ˆã®é‡è¤‡é™¤åŽ»å‡¦ç†**
   ```sql
   WITH deduplicated AS (
       SELECT
           *,
           ROW_NUMBER() OVER (PARTITION BY post.xPostId ORDER BY _PARTITIONTIME DESC) as row_num
       FROM `project.dataset.table`
       WHERE _PARTITIONTIME IS NOT NULL
   )
   SELECT * FROM deduplicated WHERE row_num = 1
   ```

3. **é‡è¤‡é™¤åŽ»ã‚’å¿˜ã‚Œã‚‹ã¨ç™ºç”Ÿã™ã‚‹å•é¡Œ**
   - æŠ•ç¨¿æ•°ãŒå®Ÿéš›ã®7å€ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹
   - ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒæ­£ã—ãè¨ˆç®—ã•ã‚Œãªã„
   - ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæŒ‡æ¨™ãŒé‡è¤‡ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹
   - æ™‚ç³»åˆ—åˆ†æžã§åŒã˜æŠ•ç¨¿ãŒè¤‡æ•°æ—¥ã«ç¾ã‚Œã‚‹

4. **é©ç”¨ã™ã¹ãã‚¯ã‚¨ãƒª**
   - æ—¥æ¬¡é›†è¨ˆã‚¯ã‚¨ãƒª
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ›ãƒ¼ãƒˆåˆ†æž
   - ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆè¨ˆç®—
   - ãƒ’ãƒ¼ãƒˆãƒžãƒƒãƒ—ãƒ»æ™‚é–“å¸¯åˆ†æž
   - **å…¨ã¦ã®ã‚¯ã‚¨ãƒªã§é‡è¤‡é™¤åŽ»ãŒå¿…é ˆ**

### ðŸ“Š æŽ¨å¥¨ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³

```sql
WITH deduplicated AS (
    SELECT
        DATE(TIMESTAMP_SECONDS(post.xPostCreatedAt)) as date,
        post.xPostId,
        user.xPostUserId as user_id,
        post.xPostLikedCount as like_count,
        -- æœ€æ–°ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’é¸æŠž
        ROW_NUMBER() OVER (PARTITION BY post.xPostId ORDER BY _PARTITIONTIME DESC) as row_num
    FROM `yoake-dev-analysis.dev_yoake_posts.*`
    WHERE _TABLE_SUFFIX IS NOT NULL 
        AND _PARTITIONTIME IS NOT NULL
        -- å¿…è¦ã«å¿œã˜ã¦æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿
        AND DATE(TIMESTAMP_SECONDS(post.xPostCreatedAt)) >= '2025-09-01'
),
base AS (
    SELECT * FROM deduplicated WHERE row_num = 1
)
SELECT
    date,
    COUNT(DISTINCT xPostId) as post_count,
    COUNT(DISTINCT user_id) as dau
FROM base
GROUP BY date
ORDER BY date
```
