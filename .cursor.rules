# Cursor Rules — AI Data Lab

## コミュニケーション
- すべての回答は日本語で行う。
- 進捗報告や設計共有では要点を簡潔にまとめ、必要ならTDDの観点を添える。

## 開発プロセス
- 可能な限りテストファースト（TDD）で進め、ユニットテスト→統合テストの順で追加する。
- Serena MCPなどの検証手段がある場合は実装前後で活用し、結果を共有する。
- コードベース全体の構造把握や影響範囲の調査は、Serena MCPのシンボリック系ツール（`get_symbols_overview` / `find_symbol` / `find_referencing_symbols` など）を優先的に用いて実施する。
- 新しいAPIやライブラリの用法・最新リリース情報が不明な場合は、Context7（`context7` MCP）で公式ドキュメントを参照し、引用元を明示する。
- 既存の変更は元に戻さず、必要な場合は利用者へ確認する。
- 環境変数（例: `GOOGLE_APPLICATION_CREDENTIALS`）は常設で書き換えず、`env -u VAR <command>` や `VAR=value <command>` の一時的な上書きで運用し、他プロジェクトへ影響させない。

## データ分析・Notebook運用
1. **目的の明確化**
   - 分析開始前に目的・ゴール・仮説を簡潔に記述し、Notebook上でも明示する。
2. **データ品質の確保**
   - 完全性・正確性・一貫性を確認する。欠損・異常値・重複の処理方針をコードとテキストで説明する。
   - データを補完・代替値で埋める場合は理由と方法を必ず記載する。
3. **バイアスと因果**
   - 主観的バイアスを排除し、収集方法の偏りがないかを確認する。
   - 相関と因果を混同しない。因果を述べるときは仮説であることを示す。
4. **分析対象の理解**
   - カラム意味・単位・収集元・更新頻度などを把握し、必要に応じてNotebookへメモする。
5. **トレーサビリティと命名**
   - 元データを上書きせず、`raw/`, `intermediate/`, `feature/`, `output/` などの階層を用いる。
   - ファイル名だけで「ソース・対象・粒度・日付」が分かる命名（例: `bq__sales__daily__2025-03-01.parquet`）を徹底する。
   - データセット生成用スクリプトやNotebookには `dataset_` などの接頭辞を付ける。
6. **文字化け対策**
   - I/O時は `encoding='utf-8'` を明示し、他のエンコーディングを使う場合は理由を記載する。
7. **EDAと可視化**
   - NotebookにはEDAタブを設け、YData ProfilingやAutoVizなどの自動EDAツールを状況に応じて利用してよい（参考: [YData Profiling](https://docs.profiling.ydata.ai/latest/), [AutoViz](https://github.com/AutoViML/AutoViz)）。
   - Squarify（ツリーマップ）やColab Charts的な「1行可視化」スタイルのツールを活用し、色・サイズ・凡例を明示する。
   - 1つのグラフに情報を詰め込みすぎず、目的に沿って分割する。
   - 可視化結果は専門家でなくても理解できるよう説明文を添える。
   
   **グラフのわかりやすさを最優先にする**:
   - ❌ **index番号（例: index=84）は使用禁止** → ✅ 意味のあるラベル（ユーザー名、日付、カテゴリ名など）を必ず使用する。
   - データの特性に応じて**適切なグラフタイプ**を選択する:
     - 棒グラフ: カテゴリ比較、ランキング
     - 折れ線グラフ: 時系列データ、トレンド
     - ヒートマップ: 2次元データ（曜日×時間帯など）
     - 積み上げグラフ: 内訳表示
     - 横棒グラフ: 長いラベル名のランキング
   - **日本語ラベル**を使用し、専門知識がなくても理解できるようにする（例: "Monday" → "月曜日"、"has_media" → "メディアあり"）。
   - **数値ラベル**を棒グラフや折れ線グラフに表示して、具体的な値を明示する（例: 棒の上に「1,791件」と表示）。
   - **グラフタイトル、軸ラベル、凡例**を必ず付け、何のデータかが一目でわかるようにする。
   - **カラーパレット**は見やすく区別しやすいものを選ぶ（色覚多様性にも配慮）。
   - **matplotlib使用時は必ず `matplotlib.use('Agg')` を設定**してGUIなしで動作させる。
   - **高解像度（300 DPI以上）**で画像を保存し、印刷・プレゼンテーションにも対応できるようにする。
8. **データセット作成の明示**
   - 新規データセットを生成する際はNotebook/READMEに目的と生成プロセスを書き、出力先ディレクトリを分ける。
9. **統計処理の妥当性**
   - 利用する統計手法の前提条件（独立性・分布など）を確認し、必要なら検証手順を示す。

## Notebook利用時の追加ルール
1. 分析目的を最初のセルに記載する。
2. 仮想環境（uvやvenv）を必ず使用し、Notebookは`edit_notebook`ツールで編集する。
3. セルには英語ラベルを用いつつ、説明は日本語で行う。
4. 勝手な分析を行わず、ファイル整理（データ/図表/レポート）を徹底する。
5. エラーが出た場合は原因と再発防止策をNotebookに追記する。
6. S3・DuckDB・JSONアクセスは既定の安全なパターン（資格情報を.envやマウントで管理）に従う。
7. 可視化や出力は標準テンプレート（目的→方法→結果→次アクション）で整理する。

## データ分析の2つのモード
データ分析には**エビデンス提示モード**と**探索モード**の2つがある。目的に応じて使い分ける。

### 📊 **エビデンス提示モード（レポート・報告書作成）**
- **目的**: 分析結果を他者に伝える、意思決定のためのエビデンスを提示する
- **ツール**: Python + matplotlib/seaborn/plotly、高解像度PNG/PDF画像生成
- **原則**: **画像（グラフ）を積極的に多用する**
  - ✅ マルチエージェントでのレポート作成時は**必ず画像を含める**
  - ✅ 数値だけの表よりも、グラフを優先（一目でわかる）
  - ✅ 複数の観点から可視化（時系列、分布、比較、相関など）
  - ✅ 高解像度（300 DPI以上）で保存し、印刷・プレゼンテーションに対応
  - ✅ レポートMarkdownには画像を埋め込む（`![](path/to/image.png)`）
- **出力例**: 
  - `reports/visualizations/*.png` - 個別グラフ画像
  - `reports/レポート.md` - 画像を多数埋め込んだMarkdownレポート
  - `reports/*.csv` - 詳細データ（補足資料）

### 🔍 **探索モード（インタラクティブ分析）**
- **目的**: データを自由に触って理解を深める、仮説検証、深堀り分析
- **ツール**: **Marimo**（インタラクティブNotebook）
- **原則**: **面白いと思った部分を自由に探索する**
  - ✅ レポートを見て興味を持った部分をMarimoで深堀り
  - ✅ パラメータをリアルタイムで変更（スライダー、ドロップダウン等）
  - ✅ フィルタリング、グループ化、集計を動的に試す
  - ✅ 新しい発見があればレポートに追加（エビデンス提示モードに戻る）
- **使い方**:
  ```bash
  # Marimoノートブックをブラウザで開く
  marimo edit notebooks/your_analysis.py --port 4173
  ```

### 📈 **推奨ワークフロー**
1. **まずエビデンス提示モード**: 包括的な分析を実行し、画像入りレポートを生成
   ```bash
   python notebooks/00_comprehensive_eda_analysis_MAIN.py
   # → 画像10種類 + CSVレポート + HTMLレポート
   ```
2. **レポートを確認**: 生成された画像とレポートを見る
3. **興味深い発見**: 「これ面白いな」と思った部分を特定
4. **探索モードに移行**: Marimoでその部分を詳しく分析
   ```bash
   marimo edit notebooks/eda_sakurai_yui.py --port 4173
   ```
5. **新しい発見を追加**: 重要な発見があれば、再度画像を生成してレポートに追加

### 🎯 使い分けの例
| 状況 | モード | ツール | 出力 |
|------|--------|--------|------|
| マルチエージェントでの報告 | 📊 エビデンス提示 | Python + matplotlib | 画像多数のレポート |
| 月次レポート作成 | 📊 エビデンス提示 | Python + seaborn | PDF + PNG画像 |
| 経営陣へのプレゼン資料 | 📊 エビデンス提示 | 高解像度グラフ | PowerPoint用画像 |
| 「木曜日だけ投稿が多い理由」を調査 | 🔍 探索 | Marimo | インタラクティブ分析 |
| 「特定ユーザーの行動パターン」を深堀り | 🔍 探索 | Marimo | リアルタイム集計 |
| 新しい仮説の検証 | 🔍 探索 | Marimo | 動的フィルタリング |

## 可視化とレポート
- レポートや可視化ファイルは `reports/` 配下に保存し、Git追跡から除外する。
- グラフやテーブルは「タイトル・データ期間・単位」を明記する。
- データプロファイリング結果はNotebookに要約し、必要ならHTML/JSONを添付する。


