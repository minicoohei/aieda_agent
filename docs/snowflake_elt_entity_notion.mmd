%% ============================================
%% InfoBox 統合ER図
%% Snowflake (ETL_S3_TRANSALES_DB) + BigQuery (production_infobox)
%% Updated: 2026-02-10
%% ============================================
erDiagram

  %% ============================================
  %% ユーザー・組織系
  %% ============================================
  USERORGANIZATION {
    string ORGID PK
    string COMPANYID FK
    string NAME
  }

  USERORGRELATION {
    string ID PK
    string USERID FK
    string ORGANIZATIONID FK
  }

  USER {
    string ID PK
    string NAME
  }

  BEEGLECOMPANY {
    string ID PK
    string COMPNO "法人番号 → BQ corporate_id"
    string SHOGO
    string SHOGOFULL
  }

  %% ============================================
  %% 1stパーティ系 (Snowflake)
  %% ============================================
  FIRSTPARTYGROUP {
    string ID PK
  }

  FIRSTPARTYVISITLOGS {
    string ID PK
    string FIRSTPARTYGROUPID FK
    string VISITORCOMPANYID FK
  }

  FIRSTPARTYSCOREVISITOR {
    string ID PK
    string FIRSTPARTYGROUPID FK
    string COMPANYID FK
    string PAGEREFERRERTYPE
  }

  FIRSTPARTYSCORECHANGE {
    string ID PK
    string FIRSTPARTYGROUPID UK
    string COMPANYID UK
    number SCORE
  }

  FIRSTPARTYSCORECHANGEHISTORY {
    string ID PK
    string FIRSTPARTYGROUPID UK
    string COMPANYID UK
    date INTENTCHANGEDATE UK
    number SCORE
  }

  %% ============================================
  %% インテントスコア系 (Snowflake)
  %% ============================================
  INTENTSCORECHANGE {
    string ID PK
    string ORIGINALPRODUCTCATEGORYID UK
    string COMPANYID UK
    number SCORE
  }

  INTENTSCORECHANGEHISTORY {
    string ID PK
    string ORIGINALPRODUCTCATEGORYID UK
    string COMPANYID UK
    date INTENTCHANGEDATE UK
    number SCORE
  }

  %% ============================================
  %% リスト系
  %% ============================================
  COMPANYLIST {
    string ID PK
    string USERORGRELATIONID FK
    timestamp CREATEDAT
  }

  _BEEGLECOMPANYTOCOMPANYLIST {
    string A FK
    string B FK
    timestamp CREATEDAT
  }

  PEOPLELIST {
    string ID PK
    string USERORGRELATIONID FK
    timestamp CREATEDAT
  }

  KEYMAN {
    string ID PK
  }

  _KEYMANTOPEOPLELIST {
    string A FK
    string B FK
    timestamp CREATEDAT
  }

  %% ============================================
  %% インポート・CSVダウンロード系
  %% ============================================
  LEADIMPORTEVENT {
    string ID PK
    string USERORGRELATIONID FK
    timestamp CREATEDAT
  }

  CSVDOWNLOADLOG {
    string ID PK
    string USERORGRELATIONID FK
    timestamp CREATEDAT
  }

  _BEEGLECOMPANYTOCSVDOWNLOADLOG {
    string A FK
    string B FK
    timestamp CREATEDAT
  }

  CSVDOWNLOADQUOTAUPDATELOG {
    string ID PK
    string USERORGRELATIONID FK
    timestamp CREATEDAT
  }

  %% ============================================
  %% 活動履歴（MEMO）系
  %% ============================================
  MEMO {
    string ID PK
    string CONTENT
    string COMPANYID FK
    timestamp CREATEDAT
    timestamp UPDATEDAT
    string REPRESENTATIVECHANGEDETAILS
    timestamp ACTIVITYDATE
    string ANYFLOWJOBID
    string USERORGRELATIONID FK
    timestamp NEXTACTIVITYDATE
    string NEXTCONTENT
    enum PRIORITY
    string STATUSSHOID FK
  }

  MEMOSTATUSSHO {
    string ID PK
    string NAME
    string MEMOSTATUSDAIID FK
  }

  MEMOSTATUSDAI {
    string ID PK
    string NAME
  }

  %% ============================================
  %% CRM系 (LEAD / NEGOTIATION)
  %% ============================================
  LEAD {
    string ID PK
    string COMPNO "法人番号 = BEEGLECOMPANY.COMPNO"
    string FIRSTNAME
    string LASTNAME
    string SHOGO "商号"
    string DEPARTMENT "部署"
    string POSITION "役職"
    string EMAIL
    string TEL
    string MOBILE
    string COMPANYID FK "BeegleCompany FK"
    string PERSONID
    string CREATEDBYLEADIMPORTEVENTID FK "LEADIMPORTEVENT FK"
    string UPDATEDBYLEADIMPORTEVENTID FK "LEADIMPORTEVENT FK"
    number HASCONTACT
    timestamp CREATEDAT
    timestamp UPDATEDAT
    number DELETED
    string JOBTYPEID
    string ORGANIZATIONID FK
    string LEADSOURCEID
    date SNAPSHOT_DATE
    timestamp LOAD_TIMESTAMP
  }

  NEGOTIATION {
    string ID PK
    string ORGANIZATIONID FK "USERORGANIZATION.ORGID"
    timestamp CREATEDAT
    timestamp UPDATEDAT
    string COMPANYID FK
    string COMPANYLISTICONTYPEID
    string CRMNEGOTIATIONID
    string CRMTYPE
    timestamp CRMCREATEDAT
    date SNAPSHOT_DATE
    timestamp LOAD_TIMESTAMP
  }

  _LEADTOPEOPLELIST {
    string A FK "lead_id (LEAD)"
    string B FK "list_id (PEOPLELIST)"
    date SNAPSHOT_DATE
    timestamp LOAD_TIMESTAMP
  }

  %% ============================================
  %% 論理マート（参考）
  %% ============================================
  GA_SF_INTENT_MART {
    string ORGID
    string COMPANYID
    number INTENT_SCORE
    number DOWNLOAD_COUNT_30D
    number LIST_ADD_COUNT_30D
    number GA_USERS_30D
  }

  %% ============================================
  %% BigQuery: 1stパーティ系 (production_infobox)
  %% ============================================
  BQ_master_first_party_group {
    string client_id PK "顧客企業の法人番号"
    string group_id PK "顧客サイトキー"
    string group_name "サイト識別子"
  }

  BQ_first_party_score_company_all_history {
    string first_party_corporate_id PK "顧客企業の法人番号"
    string corporate_id "対象企業の法人番号"
    number intent_level "3:High 2:Mid 1:Low"
    date change_date PK "スコア変動日"
  }

  BQ_first_party_score_company_all_history_by_group {
    string first_party_corporate_id PK "顧客企業の法人番号"
    string group_id PK "顧客サイトキー"
    string corporate_id "対象企業の法人番号"
    number intent_level "3:High 2:Mid 1:Low"
    date change_date PK "スコア変動日"
  }

  BQ_first_party_visitors_log {
    string first_party_corporate_id PK "顧客企業の法人番号"
    date view_date "アクセス日(JST)"
    timestamp view_datetime PK "アクセス日時(JST)"
    string corporate_id "対象企業の法人番号"
    string page_referrer_type "流入経路"
    string page_referrer_name "流入元"
    string page_title "サイト名"
    string page_location "サイトURL"
  }

  BQ_first_party_visitors_log_by_group {
    string first_party_corporate_id PK "顧客企業の法人番号"
    string group_id PK "顧客サイトキー"
    date view_date "アクセス日(JST)"
    timestamp view_datetime PK "アクセス日時(JST)"
    string corporate_id "対象企業の法人番号"
    string page_referrer_type "流入経路"
    string page_referrer_name "流入元"
    string page_title "サイト名"
    string page_location "サイトURL"
  }

  %% ============================================
  %% BigQuery: 2ndパーティ系 (production_infobox)
  %% ============================================
  BQ_master_original_product_category {
    string original_category_id PK "主キー"
    string original_category_name "インテントキーワード名"
    string service_type "大カテゴリ名"
    string category_main_name "小カテゴリ名"
    string category_sub_name "サブカテゴリ名"
  }

  BQ_score_company_category_change_v3_all_history {
    string corporate_id PK "企業の法人番号"
    string original_category_id PK "インテントキーワードFK"
    string original_category_name "インテントキーワード名"
    number intent_level "3:High 2:Mid 1:Low"
    date change_date PK "スコア変動日"
  }

  BQ_company_category_daily_v3 {
    string corporate_id PK "企業の法人番号"
    date view_date "アクセス日"
    string original_category_id FK "インテントキーワードFK"
    string original_category_name "インテントキーワード名"
  }

  %% ============================================
  %% リレーション: ユーザー・組織
  %% ============================================
  BEEGLECOMPANY ||--o{ USERORGANIZATION : "COMPANYID"
  USERORGANIZATION ||--o{ USERORGRELATION : "ORGANIZATIONID"
  USER ||--o{ USERORGRELATION : "USERID"

  %% リレーション: 1stパーティ (Snowflake)
  FIRSTPARTYGROUP ||--o{ FIRSTPARTYVISITLOGS : "FIRSTPARTYGROUPID"
  BEEGLECOMPANY ||--o{ FIRSTPARTYVISITLOGS : "VISITORCOMPANYID"
  FIRSTPARTYGROUP ||--o{ FIRSTPARTYSCOREVISITOR : "FIRSTPARTYGROUPID"
  USERORGANIZATION ||--o{ FIRSTPARTYSCOREVISITOR : "COMPANYID"

  %% リレーション: インテントスコア (Snowflake)
  FIRSTPARTYGROUP ||--o{ FIRSTPARTYSCORECHANGE : "FIRSTPARTYGROUPID"
  BEEGLECOMPANY ||--o{ FIRSTPARTYSCORECHANGE : "COMPANYID"
  FIRSTPARTYGROUP ||--o{ FIRSTPARTYSCORECHANGEHISTORY : "FIRSTPARTYGROUPID"
  BEEGLECOMPANY ||--o{ FIRSTPARTYSCORECHANGEHISTORY : "COMPANYID"
  BEEGLECOMPANY ||--o{ INTENTSCORECHANGE : "COMPANYID"
  BEEGLECOMPANY ||--o{ INTENTSCORECHANGEHISTORY : "COMPANYID"

  %% リレーション: リスト
  USERORGRELATION ||--o{ COMPANYLIST : "USERORGRELATIONID"
  BEEGLECOMPANY ||--o{ _BEEGLECOMPANYTOCOMPANYLIST : "A"
  COMPANYLIST ||--o{ _BEEGLECOMPANYTOCOMPANYLIST : "B"

  USERORGRELATION ||--o{ PEOPLELIST : "USERORGRELATIONID"
  KEYMAN ||--o{ _KEYMANTOPEOPLELIST : "A"
  PEOPLELIST ||--o{ _KEYMANTOPEOPLELIST : "B"

  %% リレーション: インポート・CSVダウンロード
  USERORGRELATION ||--o{ LEADIMPORTEVENT : "USERORGRELATIONID"

  USERORGRELATION ||--o{ CSVDOWNLOADLOG : "USERORGRELATIONID"
  CSVDOWNLOADLOG ||--o{ _BEEGLECOMPANYTOCSVDOWNLOADLOG : "A"
  BEEGLECOMPANY ||--o{ _BEEGLECOMPANYTOCSVDOWNLOADLOG : "B"
  USERORGRELATION ||--o{ CSVDOWNLOADQUOTAUPDATELOG : "USERORGRELATIONID"

  %% リレーション: MEMO
  USERORGRELATION ||--o{ MEMO : "USERORGRELATIONID"
  BEEGLECOMPANY ||--o{ MEMO : "COMPANYID"
  MEMOSTATUSSHO ||--o{ MEMO : "STATUSSHOID"
  MEMOSTATUSDAI ||--o{ MEMOSTATUSSHO : "MEMOSTATUSDAIID"

  %% リレーション: CRM (LEAD / NEGOTIATION)
  BEEGLECOMPANY ||--o{ LEAD : "COMPANYID"
  LEADIMPORTEVENT ||--o{ LEAD : "CREATEDBYLEADIMPORTEVENTID"
  LEADIMPORTEVENT ||--o{ LEAD : "UPDATEDBYLEADIMPORTEVENTID"
  LEAD ||--o{ _LEADTOPEOPLELIST : "A"
  PEOPLELIST ||--o{ _LEADTOPEOPLELIST : "B"
  BEEGLECOMPANY ||--o{ NEGOTIATION : "COMPANYID"
  USERORGANIZATION ||--o{ NEGOTIATION : "ORGANIZATIONID"

  %% リレーション: 論理マート
  USERORGANIZATION ||--o{ GA_SF_INTENT_MART : "ORGID"
  BEEGLECOMPANY ||--o{ GA_SF_INTENT_MART : "COMPANYID"

  %% リレーション: BigQuery 1stパーティ
  %% BQ テーブルは corporate_id (法人番号) で BEEGLECOMPANY.COMPNO と結合可能
  BQ_master_first_party_group ||--o{ BQ_first_party_score_company_all_history_by_group : "group_id"
  BQ_master_first_party_group ||--o{ BQ_first_party_visitors_log_by_group : "group_id"

  %% リレーション: BigQuery 2ndパーティ
  BQ_master_original_product_category ||--o{ BQ_score_company_category_change_v3_all_history : "original_category_id"
  BQ_master_original_product_category ||--o{ BQ_company_category_daily_v3 : "original_category_id"

  %% ============================================
  %% COMPNO (法人番号) 紐づけ
  %% ============================================
  %% BEEGLECOMPANY.COMPNO は以下と結合可能:
  %%   - LEAD.COMPNO (Snowflake CRM)
  %%   - BQ corporate_id (BigQuery 全テーブル)
  %%   - infobox_data.tsv COMPNO カラム
